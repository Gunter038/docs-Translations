- - -
sidebar_label : Слой доступности данных Celestia
- - -

# Жизненный цикл транзакции приложения Celestia

Пользователи запрашивают приложение Celestia для того, чтобы сделать данные доступными, отправив `PayForData` транзакции. Каждая такая транзакция состоит из идентификатора отправителя, данных, которые должны быть доступны, также называется сообщением, размер данных, идентификатор пространства имен и подпись. Каждый производитель блоков собирает несколько `PayForData` транзакций в блок.

Однако прежде чем предложить блок, производитель передает его в конечный автомат через ABCI++, где каждая транзакция `PayForData` разделяется на сообщение с пространством имен (обозначенное `Msg` на рисунке ниже), т.е. на данные вместе с идентификатором пространства имен, и исполняемую транзакцию (обозначенную `e-Tx` на рисунке ниже), которая не содержит данные, а только обязательство, которое может быть использовано позже, чтобы доказать, что данные действительно были доступны.

Таким образом, данные блоков состоят из данных, разделенных на пространства имен и исполняемые транзакции. Обратите внимание, что только эти транзакции выполняются конечным автоматом Celestia после совершения блока.

![Жизненный цикл транзакции приложения Celestia](/img/concepts/tx-lifecycle.png)

Далее производитель блока добавляет к заголовку блока обязательство данных блока. Как описано [здесь](./data-availability-layer.md#fraud-proofs-of-incorrectly-extended-data), обязательство является корнем Меркла из 4k промежуточных корней Меркла (т.е. по одному для каждой строки и столбца расширенной матрицы). Для расчета этого обязательства, производитель блоков выполняет следующие операции:

- Он разделяет исполняемые транзакции и данные с именами на части. Каждая часть состоит из нескольких байт, начинающихся с идентификатора пространства имен. Для этого исполняемые транзакции ассоциируются с зарезервированным пространством имен.
- Он упорядочивает эти части в квадратную матрицу (по строкам). Обратите внимание, что части дополняются до следующей степени двойки. Итоговый квадрат размером k × k называется исходными данными.
- Он расширяет исходные данные до квадратной матрицы 2k × 2k, используя 2-мерную систему кодирования Рида-Соломона, описанную выше. Расширенные части (т.е. содержащие данные об удалении) ассоциируются с другим зарезервированным пространством имен.
- Он вычисляет обязательство для каждой строки и столбца расширенной матрицы, используя NMT, описанное выше.

Таким образом, фиксация данных блока является корнем дерева Меркла с листьями, корнями леса поддеревьев Меркла с пространством имен по одному на каждую строку и столбец расширенной матрицы.

## Проверка доступности данных

![Сеть доступности данных](/img/concepts/consensus-da.png)

Для расширения возможностей связи узел Celestia дополняет приложение Celestia отдельной сетью libp2p, т.е. так называемой _DA-сетью_, которая обслуживает запросы DAS.

Легкие узлы подключаются к узлу Celestia в сети DA, просматривают расширенные заголовки блоков (т.е. заголовки блоков вместе с соответствующими метаданными DA, такими как промежуточные корни Меркла в формате 4k), и реализуют DAS на полученных заголовках (т.е. запрашивают случайные фрагменты данных).

Обратите внимание, несмотря на то, что это рекомендуется, выполнение DAS является необязательным - легкие узлы могут просто доверять тому, что данные, соответствующие обязательствам в заголовках блоков действительно были предоставлены слоем Celestia DA. Кроме того, легкие узлы могут отправлять транзакции в приложение Celestia, т.е. транзакции `PayForData`.

Во время выполнения DAS для заголовка блока, каждый легкий узел запрашивает у узлов Celestia несколько случайных фрагментов данных из расширенной матрицы и соответствующие доказательства Меркла. Если все запросы успешны, то легкий узел принимает заголовок блока как достоверный (с точки зрения DA).

Если хотя бы один из запросов не выполняется (т.е. либо фрагмент данных не был получен, либо доказательство Меркла недействительно), то легкий узел отвергает заголовок блока и повторяет попытку позже. Повторная проверка необходима для борьбы с ложными отрицаниями, т.е. заголовки блоков отклоняются, хотя данные блока доступны. Это может произойти в результате перегруженности сети.

В качестве альтернативы, легкие узлы могут принять заголовок блока, хотя данные недоступны, т.е. _ложноположительный ответ_. Это возможно, поскольку свойство надежности (т.е. если честный легкий узел принимает блок как доступный, то по крайней мере один честный полный узел в конечном итоге будет иметь все данные блока) вероятностно гарантировано (для получения более подробной информации посмотрите на [оригинальную статью](https://arxiv.org/abs/1809.09044)).

Путем точной настройки параметров Celestia (например, количество блоков данных, отбираемых каждым легким узлом) вероятность ложных срабатываний может быть в достаточной степени чтобы у производителей блоков не было стимула скрывать данные о блоках.
